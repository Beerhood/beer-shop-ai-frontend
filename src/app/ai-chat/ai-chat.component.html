<div class="chat-wrapper flex justify-center w-full h-[calc(90vh)] px-4 py-6">
  <p-card
    [style]="{
      width: '100%',
      maxWidth: '1000px',
      height: '100%',
      display: 'flex',
      flexDirection: 'column',
    }"
    styleClass="h-full shadow-lg"
  >
    <ng-template pTemplate="header">
      <div class="bg-amber-500 p-4 rounded-t-lg flex items-center gap-3 text-white">
        <i class="pi pi-sparkles text-2xl"></i>
        <div>
          <h2 class="text-xl font-bold m-0">Beerhood AI Assistant</h2>
          <p class="text-sm opacity-90 m-0">Ask me about beer, snacks, or pairings!</p>
        </div>
      </div>
    </ng-template>

    <div class="flex flex-col flex-grow overflow-hidden h-full relative">
      <div #scrollContainer class="flex-grow overflow-y-auto p-4 space-y-4 scroll-smooth">
        @for (msg of messages(); track msg) {
          <div
            class="flex w-full"
            [ngClass]="{
              'justify-end': msg.sender === 'user',
              'justify-start': msg.sender === 'ai',
            }"
          >
            <div
              class="flex max-w-[80%] gap-2"
              [ngClass]="{ 'flex-row-reverse': msg.sender === 'user' }"
            >
              <p-avatar
                [icon]="msg.sender === 'ai' ? 'pi pi-bolt' : 'pi pi-user'"
                shape="circle"
                [styleClass]="
                  (msg.sender === 'ai'
                    ? 'bg-gray-200 text-gray-700'
                    : 'bg-amber-100 text-amber-700') + ' flex-shrink-0'
                "
              />

              <div
                class="p-3 rounded-2xl text-sm leading-relaxed shadow-sm whitespace-pre-wrap"
                [ngClass]="{
                  'bg-amber-500 text-white rounded-tr-none': msg.sender === 'user',
                  'text-color rounded-tl-none': msg.sender === 'ai' && !msg.isError,
                  'bg-red-50 text-red-600 border border-red-200 rounded-tl-none': msg.isError,
                }"
              >
                {{ msg.content }}
                <div
                  class="text-[10px] opacity-70 mt-1 text-right"
                  [ngClass]="{ 'text-white': msg.sender === 'user' }"
                >
                  {{ msg.timestamp | date: 'shortTime' }}
                </div>
              </div>
            </div>
          </div>
        }

        @if (isLoading()) {
          <div class="flex justify-start w-full">
            <div class="flex items-center gap-2 ml-10 bg-surface-50 px-4 py-2 rounded-l">
              <p-progressSpinner [style]="{ width: '30px', height: '30px' }" strokeWidth="5" />
              <span class="text-xs text-gray-500">Thinking...</span>
            </div>
          </div>
        }
      </div>

      <div class="p-4 border-t border-surface-200 bg-surface-0">
        <div class="flex gap-2">
          <input
            type="text"
            pInputText
            [(ngModel)]="userInput"
            (keydown)="handleKeydown($event)"
            placeholder="Type your question here..."
            class="w-full"
            [disabled]="isLoading()"
          />
          <p-button
            icon="pi pi-send"
            (onClick)="sendMessage()"
            [disabled]="!userInput.trim() || isLoading()"
            severity="primary"
          />
        </div>
      </div>
    </div>
  </p-card>
</div>
